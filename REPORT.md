# Отчёт по проекту «Калькулятор»

## 1. Что сделали?
- Базовый фронтенд: React + Vite + TypeScript, TailwindCSS, Axios, структура `Webplatform/src/components`, интеграция форм калькулятора и отображения результатов.
- Контейнеризация фронтенда: двухэтапный Dockerfile (Build Node → Serve Nginx), кастомный `nginx.conf` для SPA, публикация на 80 порту. Добавлен сервис `frontend` в `docker-compose.yml` с привязкой к API.
- Бэкенд: FastAPI + SQLAlchemy + PostgreSQL. Расширены и переработаны модели БД (refbooks, окна/модификаторы, перегородки, доставка, базовые цены).
- Полный рефактор синхронизации с Google Sheets (gspread): порядок очистки/загрузки, маппинг FK, разбор JSONB, паузы для квот, очистка заголовков, логирование и устойчивость к отсутствующим листам.
- Ценовой движок (`pricing_engine`): новая логика базовой цены с разветвлением по контуру (cold/warm) и этажности; расчёт допов (высота потолка, конёк, вынос крыши, перегородки), доставка, стандартные окна и механизм «замещения» при выборе кастомных окон.
- CORS и стабильная работа фронт↔бэк (422 устранены за счёт гибких схем, фронт принудительно парсит числовые поля).
- Технические фиксы: устранение SyntaxError/локалей, обработка Enum в выводе, фолбэки для неидеальных данных из БД, улучшения лога ошибок.

## 2. Какие проблемы решали и как?
- Инициализация фронтенда и сборка: вместо «нечистого» `npm create vite` реализована ручная структура + конфиги (vite, tsconfig, tailwind, postcss), Dockerfile и nginx для стабильной сборки/раздачи.
- Ошибки 422 от API: на фронте — строгое преобразование select в числа, на бэкенде — более гибкие поля схем (float/int), удаление пустых опциональных полей при отправке.
- Синхронизация с Google Sheets: добавлены:
  - очистка и повторная загрузка референтных/данных в правильном порядке;
  - нормализация заголовков (strip/удаление переносов), разбор JSONB;
  - интеллектуальный маппинг FK (code/title/mm), сообщения о пропущенных строках;
  - паузы между запросами (quota friendly);
  - детальное логирование ошибок для быстрой диагностики.
- Разделение `base_price_m2` на `base_price_cold`/`base_price_warm_1f`/`base_price_warm_2f` с обновлением моделей, синка и движка расчётов.
- Окна: реализовано отображение стандартных окон (учтённых в базе) и корректный подсчёт модификаторов для кастомных окон (неаддитивная логика).
- Доставка: единая формула и строка детализации в выдаче.

## 3. Что имеем сейчас?
- Фронтенд в Docker/Nginx, доступный по `http://localhost:8080`, связанный с API на `http://localhost:8000`.
- Бэкенд обрабатывает расчёты, вычисляет базовую стоимость (по warm/cold и этажности), допы (высота/конёк/вынос, перегородки), доставку, стандартные окна (при корректных данных в таблице).
- Синхронизация с Google Sheets стабильна; есть логи по пропущенным строкам с указанием причины (пустой/неверный FK, невалидный JSON и т.д.).
- Фронт отправляет корректные payload, 422 устранены; UI визуально аккуратный и удобный.

## 4. Какие проблемы остаются и почему?
- Окна и двери: «Стандартные окна» не отображались, когда лист `std_inclusions` содержал некорректные заголовки/значения — строки скипаются при синке. Двери пока не конфигурируются во фронте (нет UI) и не учитываются в сумме.
- Утепление/контуры: при неполных/нулевых ценах в `base_price_*` (или при несоответствии кодов/этажности) базовая цена может быть 0 — движок делает фолбэки, но полностью полагаться на них нельзя.
- Конёк (тип потолка = «по стропилам»): для «rafters» базовая цена идёт по ветке мансарды; повышение конька считается только для `flat` (как в текущей версии прайса). Для «rafters» нужны явные правила/прайс.
- Ошибки в Google Sheets: некондиционные заголовки/значения в `std_inclusions` (например, `contour_code='warm'`, «подсказки» в заголовке типа `('gluh'|...)`, кириллица в коде этажности, одинарные кавычки в JSON и т.п.).
- Террасы/крыльца: в `addons` нет позиций с кодами для расчёта по площади, поэтому не попадают в стоимость.

## 5. Варианты решений и ожидаемый результат
1) Привести лист `std_inclusions` к строгому формату заголовков и значений:
   - Заголовки: `tech_code`, `contour_code`, `storey_type_code`, `area_to_qty`, `included_window_width_cm`, `included_window_height_cm`, `included_window_type`.
   - `contour_code` — `warm`/`cold` (в ячейке, а не в заголовке).
   - `storey_type_code` — `one`/`mansard`/`two`.
   - `included_window_type` — одно из `gluh|povorot|povorot_otkid`.
   - `area_to_qty` — валидный JSON c двойными кавычками, например:  
     `[{"max_m2": 36, "qty": 2}, {"max_m2": 60, "qty": 3}]`.
   Ожидаемый результат: строки перестанут скипаться, стандартные окна появятся в ответе и визуализации.

2) Дополнить `addons` позициями для террас и крылец (расчёт по площади):
   - `terrace_m2` (`AREA`, `price = <руб/м²>`), `porch_m2` (`AREA`, `price = <руб/м²>`).
   Ожидаемый результат: в блоке «Дополнения» появятся террасы/крыльца с корректной суммой.

3) Проверить прайсы `base_price_*` на предмет нулевых/отсутствующих цен и соответствия кодов: `tech_code`, `brand_code`, `mm`, `storey_type_code`. При необходимости — расширить листы, чтобы покрыть все комбинации.
   Ожидаемый результат: стабильная ненулевая базовая стоимость для всех поддерживаемых конфигураций.

4) Конёк для `rafters`: согласовать бизнес‑логику/прайс (нужно ли считать для «по стропилам», в какой таблице/правиле), после чего добавить соответствующий расчёт.
   Ожидаемый результат: корректная строка «повышение конька» при `rafters` (если это предусмотрено прайсом).

5) Двери/окна (кастом): при необходимости добавить UI для выбора дверей и окон, расходящиеся прайсы, подсчёт и вывод с модификаторами.
   Ожидаемый результат: полный раздел «Окна и двери» с учётом стандартного комплекта и замещения.

## 6. Что делать после правок
1) Обновить Google Sheets (по пунктам выше).  
2) Запустить синк: `POST /admin/sync-prices` (или `Invoke-WebRequest -Uri http://localhost:8000/admin/sync-prices -Method POST`).  
3) Пересчитать на фронте — проверить базу, окна, террасы/крыльца, перегородки, конёк/высоту потолка.

---
Готовы быстро внести изменения в код для поддержки согласованных форматов и новых интерфейсов (двери/кастомные окна/террасы в UI). После выравнивания данных расчёты будут полными и предсказуемыми.
*** End Patch***}')

