# Пример структуры данных для листа std_inclusions

## Описание

Лист `std_inclusions` в Google Sheets используется для хранения стандартных включений (комплектаций) для разных конфигураций домов.

## Структура данных

### Обязательные колонки

| Название колонки | Тип | Описание | Пример значения |
|------------------|-----|----------|----------------|
| `tech_code` | Text | Код технологии строительства | `frame`, `log`, `brick` |
| `contour_code` | Text | Код контура | `warm`, `cold` |
| `storey_type_code` | Text | Код типа этажности | `one`, `mansard`, `two` |
| `included_window_width_cm` | Integer | Ширина включенного окна (см) | `100` |
| `included_window_height_cm` | Integer | Высота включенного окна (см) | `100` |
| `included_window_type` | Enum | Тип окна | `povorot_otkid`, `gluh`, `povorot` |
| `area_to_qty` | JSON | Зависимость количества от площади | `[{"max_m2": 36, "qty": 2}, {"max_m2": 60, "qty": 3}]` |

### Опциональные колонки

| Название колонки | Тип | Описание | Пример значения |
|------------------|-----|----------|----------------|
| `included_entry_door_code` | Text | Код входной двери | `steel_door_01` |
| `included_interior_doors_qty` | Integer | Количество межкомнатных дверей | `3` |
| `note` | Text | Примечание | `Стандартная комплектация для одноэтажного дома` |

## Пример данных

### Вариант 1: Минимальная конфигурация

| tech_code | contour_code | storey_type_code | included_window_width_cm | included_window_height_cm | included_window_type | area_to_qty |
|-----------|--------------|------------------|--------------------------|---------------------------|---------------------|-------------|
| frame | warm | one | 100 | 100 | povorot_otkid | `[{"max_m2": 36, "qty": 2}, {"max_m2": 60, "qty": 3}]` |
| frame | warm | mansard | 100 | 120 | povorot_otkid | `[{"max_m2": 40, "qty": 2}, {"max_m2": 70, "qty": 4}]` |

### Вариант 2: Полная конфигурация

| tech_code | contour_code | storey_type_code | included_window_width_cm | included_window_height_cm | included_window_type | area_to_qty | included_entry_door_code | included_interior_doors_qty | note |
|-----------|--------------|------------------|--------------------------|---------------------------|---------------------|-------------|--------------------------|----------------------------|------|
| frame | warm | one | 100 | 100 | povorot_otkid | `[{"max_m2": 36, "qty": 2}, {"max_m2": 60, "qty": 3}]` | steel_door_01 | 3 | Стандарт для 1 этажа |
| frame | warm | mansard | 100 | 120 | povorot_otkid | `[{"max_m2": 40, "qty": 2}, {"max_m2": 70, "qty": 4}]` | steel_door_02 | 5 | Стандарт для мансарды |

## Формат JSON для area_to_qty

Поле `area_to_qty` должно содержать JSON массив объектов с двумя полями:
- `max_m2` - максимальная площадь дома в м²
- `qty` - количество окон для этой площади

### Примеры:

**Простой вариант:**
```json
[{"max_m2": 36, "qty": 2}, {"max_m2": 60, "qty": 3}]
```

**Расширенный вариант:**
```json
[
  {"max_m2": 36, "qty": 2},
  {"max_m2": 60, "qty": 3},
  {"max_m2": 80, "qty": 5},
  {"max_m2": 120, "qty": 7}
]
```

### Логика работы:

- Если площадь дома ≤ 36 м², включается 2 окна
- Если площадь дома > 36 м² и ≤ 60 м², включается 3 окна
- Если площадь дома > 60 м², включается следующее количество по списку

## Значения Enum для included_window_type

Допустимые значения:
- `gluh` - глухое окно (без открывания)
- `povorot` - поворотное окно
- `povorot_otkid` - поворотно-откидное окно (рекомендуется)

## Коды для справочных таблиц

### tech_code (Технологии строительства)

Коды зависят от данных в таблице `build_technologies`. Типичные значения:
- `frame` - каркасная технология
- `log` - бревно
- `timber` - брус
- `brick` - кирпич
- `sip` - СИП-панели

Чтобы узнать доступные коды, выполните SQL запрос:
```sql
SELECT code, title FROM build_technologies;
```

### contour_code (Контуры)

Коды зависят от данных в таблице `contours`. Типичные значения:
- `warm` - тёплый контур
- `cold` - холодный контур

Чтобы узнать доступные коды, выполните SQL запрос:
```sql
SELECT code, title FROM contours;
```

### storey_type_code (Типы этажности)

Коды зависят от данных в таблице `storey_types`. Типичные значения:
- `one` - одноэтажный дом (плоский потолок)
- `mansard` - мансардный дом (стропильная крыша)
- `two` - двухэтажный дом

Чтобы узнать доступные коды, выполните SQL запрос:
```sql
SELECT code, title FROM storey_types;
```

## Проверка данных перед синхронизацией

Перед синхронизацией убедитесь, что:

1. ✅ Все коды (`tech_code`, `contour_code`, `storey_type_code`) существуют в соответствующих справочных таблицах
2. ✅ Поле `area_to_qty` содержит валидный JSON
3. ✅ Значения `included_window_type` соответствуют enum: `gluh`, `povorot`, `povorot_otkid`
4. ✅ Нет дубликатов по комбинации (`tech_code`, `contour_code`, `storey_type_code`)
5. ✅ Все обязательные колонки заполнены

## Что происходит при синхронизации

1. Данные читаются из листа `std_inclusions` в Google Sheets
2. Коды преобразуются в ID:
   - `tech_code` → `tech_id`
   - `contour_code` → `contour_id`
   - `storey_type_code` → `storey_type_id`
3. Если код не найден в справочной таблице, строка пропускается с предупреждением
4. Таблица `std_inclusions` в БД очищается
5. Новые данные вставляются в таблицу

## Ошибки и их решение

### Ошибка: "null value in column tech_id violates not-null constraint"

**Причина:** В Google Sheets отсутствует колонка `tech_code` или значение в ней пустое.

**Решение:**
1. Убедитесь, что в листе есть колонка `tech_code`
2. Проверьте, что все строки имеют значение в этой колонке
3. Убедитесь, что код существует в таблице `build_technologies`

### Ошибка: "Warning: Unknown tech_code 'XXX', skipping row"

**Причина:** Код `XXX` не найден в таблице `build_technologies`.

**Решение:**
1. Проверьте правильность написания кода
2. Убедитесь, что в таблице `build_technologies` есть запись с таким кодом
3. Если нужно, добавьте новую запись в `build_technologies`

### Ошибка при парсинге JSON в area_to_qty

**Причина:** Неправильный формат JSON.

**Решение:**
1. Проверьте, что JSON валиден (используйте https://jsonlint.com/)
2. Убедитесь, что используются двойные кавычки `"`, а не одинарные `'`
3. Проверьте правильность структуры: `[{"max_m2": число, "qty": число}, ...]`

## Дополнительная информация

- Синхронизация выполняется через эндпоинт: `POST /admin/sync-prices`
- Все операции логируются в консоль
- При ошибке синхронизации транзакция откатывается, и данные в БД остаются неизменными
